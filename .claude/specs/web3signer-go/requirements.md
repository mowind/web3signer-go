# web3signer-go 需求文档

## 概述

web3signer-go 是一个基于 MPC-KMS（多方计算密钥管理服务）的以太坊 JSON-RPC 签名服务。它提供有限的 ETH JSON-RPC 接口，并将不支持的接口转发到下游服务。

## 核心需求

### 1. HTTP 服务器功能

**用户故事**：作为服务管理员，我想要通过命令行参数配置 HTTP 服务器，以便灵活部署服务。

**验收标准**：
1.1 服务必须支持 `--http-host` 参数指定监听主机
1.2 服务必须支持 `--http-port` 参数指定监听端口
1.3 服务必须支持 `--downstream-http-host` 参数指定下游服务主机
1.4 服务必须支持 `--downstream-http-port` 参数指定下游服务端口
1.5 服务必须支持 `--downstream-http-path` 参数指定下游服务路径
1.6 服务启动时必须绑定到指定主机和端口
1.7 服务必须正确处理 HTTP 请求和响应

### 2. MPC-KMS 集成

**用户故事**：作为签名服务，我想要与 MPC-KMS 服务集成，以便使用多方计算进行安全签名。

**验收标准**：
2.1 服务必须支持 `--kms-endpoint` 参数指定 MPC-KMS 服务端点
2.2 服务必须支持 `--kms-access-key-id` 参数指定访问密钥 ID（支持环境变量）
2.3 服务必须支持 `--kms-secret-key` 参数指定密钥（支持环境变量）
2.4 服务必须支持 `--kms-key-id` 参数指定要使用的密钥 ID
2.5 服务必须实现 MPC-KMS 的 HTTP 签名认证机制
2.6 服务必须正确处理 MPC-KMS 的错误响应
2.7 服务不考虑异步签名审批，假设所有签名请求都是同步的

### 3. ETH JSON-RPC 接口支持

**用户故事**：作为以太坊客户端，我想要通过标准 JSON-RPC 接口进行签名操作，以便与现有工具链兼容。

**验收标准**：
3.1 服务必须实现 `eth_accounts` 接口（暂时返回空数组）
3.2 服务必须实现 `eth_sign` 接口，支持对任意数据进行签名
3.3 服务必须实现 `eth_signTransaction` 接口，支持对交易进行签名
3.4 服务必须实现 `eth_sendTransaction` 接口，支持签名并发送交易
3.5 服务必须使用 [ethgo](https://github.com/umbracle/ethgo) 库构建和序列化交易
3.6 服务必须遵循 [ETH JSON-RPC 规范](https://ethereum.org/zh/developers/docs/apis/json-rpc/)
3.7 服务必须正确处理 JSON-RPC 请求格式和响应格式
3.8 服务必须支持批量 JSON-RPC 请求（请求数组）

### 4. 下游服务转发

**用户故事**：作为代理服务，我想要将不支持的 JSON-RPC 方法转发到下游服务，以便提供完整的 JSON-RPC 功能。

**验收标准**：
4.1 服务必须将不支持的 JSON-RPC 方法转发到配置的下游服务
4.2 服务必须保持请求的 JSON-RPC ID 不变
4.3 服务必须正确处理下游服务的响应和错误
4.4 服务必须支持下游服务的超时配置
4.5 服务必须记录转发请求的日志

### 5. 配置管理

**用户故事**：作为运维人员，我想要通过命令行参数配置所有服务参数，以便简化部署和运维。

**验收标准**：
5.1 所有配置必须通过命令行参数提供
5.2 服务必须验证必需参数的完整性
5.3 服务必须提供合理的默认值（如适用）
5.4 服务启动时必须输出当前配置摘要

### 6. 错误处理

**用户故事**：作为用户，我想要清晰的错误信息，以便快速诊断问题。

**验收标准**：
6.1 服务必须返回符合 JSON-RPC 规范的错误响应
6.2 服务必须记录详细的错误日志
6.3 服务必须将 MPC-KMS 的错误直接返回给客户端
6.4 服务必须处理网络超时和连接错误

### 7. 日志记录

**用户故事**：作为运维人员，我想要详细的日志记录，以便监控服务运行状态。

**验收标准**：
7.1 服务必须记录所有 HTTP 请求和响应
7.2 服务必须记录 MPC-KMS 调用详情
7.3 服务必须记录下游服务转发详情
7.4 服务必须支持日志级别配置

## 技术约束

1. **编程语言**：Go
2. **Web 框架**：gin
3. **配置管理**：viper + cobra
4. **日志框架**：logrus
5. **交易构建库**：ethgo
6. **许可证**：GPLv3
7. **MPC-KMS 协议**：基于 HTTP 的自定义签名认证

## 成功标准

1. 服务能够成功启动并监听指定端口
2. 服务能够正确处理支持的 ETH JSON-RPC 方法
3. 服务能够成功调用 MPC-KMS 进行签名
4. 服务能够正确转发不支持的 JSON-RPC 方法到下游服务
5. 服务返回符合规范的 JSON-RPC 响应
6. 服务提供清晰的错误信息和日志

## 已知限制

1. `eth_accounts` 接口暂时返回空数组，因为 MPC-KMS 不提供获取地址列表的接口
2. 仅支持通过 MPC-KMS 进行签名，不支持其他签名机制
3. 配置仅支持命令行参数，不支持配置文件
4. 服务不提供密钥管理功能（密钥在 MPC-KMS 中管理）
5. 仅支持单个固定的 key_id（通过命令行参数指定）
6. 不考虑异步签名审批场景
7. 暂时不考虑性能优化